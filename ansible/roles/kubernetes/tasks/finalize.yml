- name: Ingress Nginx Repo
  kubernetes.core.helm_repository:
    name: ingress-nginx
    repo_url: "https://kubernetes.github.io/ingress-nginx"

- name: Ingress
  kubernetes.core.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    release_namespace: ingress-nginx
    #    chart_version: "{{ cilium_version }}"
    create_namespace: true
    wait: true
    values:
      rbac:
        create: true
      controller:
        kind: DaemonSet
        service:
          type: ClusterIP
        hostNetwork: true
        ingressClassResource:
          default: true

- name: Gatekeeper Repo
  kubernetes.core.helm_repository:
    name: gatekeeper
    repo_url: "https://open-policy-agent.github.io/gatekeeper/charts"

- name: Gatekeeper
  kubernetes.core.helm:
    name: gatekeeper
    chart_ref: gatekeeper/gatekeeper
    release_namespace: gatekeeper-system
    chart_version: "3.18.2"
    create_namespace: true
    wait: true


- name: Jetstack Repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: "https://charts.jetstack.io"

- name: Cert manager
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    chart_version: "1.17.2"
    create_namespace: true
    wait: true
    values:
      installCRDs: true

- name: Cert manager
  ansible.builtin.shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: selfsigned-issuer
    spec:
      selfSigned: {}
    EOF


- name: Argo Repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "https://argoproj.github.io/argo-helm"

- name: ArgoCD
  kubernetes.core.helm:
    name: argo-cd
    chart_ref: argo/argo-cd
    release_namespace: argo-cd
#    chart_version: "{{ cilium_version }}"
    create_namespace: true
    wait: true
    values:
      global:
        domain: argocd.127.0.0.1.sslip.io
      server:
        ingress:
          enabled: true
          tls: true
          annotations:
            cert-manager.io/cluster-issuer: selfsigned-issuer
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"